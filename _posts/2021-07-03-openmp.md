---
layout: post
title: "openMP"
author: dazuo
date: 2020-07-03 20:19:00 +0800
categories: [openMP]
tags: [openMP]
math: true
mermaid: true
---

# Intro
OpenMP是一种用于共享内存并行系统的多线程程序设计方案，支持C/C++/Fortran.

OpenMP由三部分组成
- 编译器指令(compiler directives)
- 运行时库程序(runtime routines)
- 环境变量(environment variables)

# OpenMP's machine model

![OpenMP's machine model](../img/openMP/openmp-machine-model.png)

### OpenMP: Shared-Memory Parallel Programming Model

### All processors/cores access a shared main memory.

### Parallelization in OpemMP employs multiple threads.


# OpenMP's memory model
![OpenMP's memory model](../img/openMP/openmp-memory-model.png)

### All threads have access to the same, globally shared memory.

### Data in private memory is only accessible by the thread owning the memory.

### No other thread sees the changes in private memory.

### Data Transfer is through shared memory and 100% transparent to the application.


# OpenMP's Execution model
![OpenMP's Execution model](../img/openMP/openmp-execution-model.png)

### OpenMP programs starts with just one thread: The Master Thread. It's used as an Initial Thread.

### Worker threads are spawned at Paralllel Region, together with the Master they form the team of threads.

### In between Parallel Regions the Worker Threads are put to sleep. The OpenMP Runtime takes care of all thead management work.

### Concept: fork-join
Allows for an incremental parallelization.


# Parallel Region and Structured Blocks

### The parallelism has to be expressed explictly
```cpp
#pragma omp parallel
{
    ...
    structured block
    ...
}
```

### structured block
- exactly one entry point at the top
- exactly one exit point at the bottom
- Branching in or out is not allowed
- terminating the program is allowed(abort/exit)

### specification if num of threads
- Environment variable: 
    ```bash
    export OMP_NUM_THREADS=...
    ```

- via num_threads clause

    add `num_threads` to the parallel construct


# `Worksharing`

### If only the `parallel` construct is used, each thread executes the structured block.

### Program speedup: `Worksharing`

### OpenMP's most common `Worksharing` construct: for
```cpp
int i;
#pragma omp for
for (i = 0; i < 100; ++i) {
    a[i] = b[i] + c[i];
}
```
#### distrubution of loop iterations over all threads in a Team.

#### Scheduling of the distrubution can be influenced.

### Loops often account for most of a program's runtime.

![Workingsharing illustration](../img/openMP/workingsharing.png)


### influencing the for loop scheduling

#### for-construct: OpenMP allows to influence how the iterations are scheduled among the threads of the team, via the schedule clause.
- schedule(static [, chunk]): Iteration space divided into blocks of chunk size, blocks are assigned to threads in a round-robin fasion. If chunk is not specified: #threads blocks.
- schedule(dynamic [, chunk]): Iteration space divided into blocks of chunk(not specified: 1) size, blocks are scheduled to threads in the order in which threads finish previous blocks.
- schedule(guided [, chunk]):Similar to dynamic, but block size starts with implementation-defined value, then is decreased exponentially down to chunk.

#### default on most implementation is shcedule(static).

### Critical Region
A Critical Region is executed by all threads, but by only one thread simultaneously(Mutual Exclusion)
```cpp
int i, s= 0;
#pragma omp parallel for
for (i = 0; i < 100; ++i) {
    #pragma omp critical
    { s = s + a[i]; }
}
```

### The Barrier Construct

Threads wait until all the threads of the current Team have reached the barrier.
```cpp
#pragma omp barrier
```
All worksharing constructs contain an implict barrier at the end.

### The Single Construct
```cpp
#pragma omp single [clause]
... structured block ...
```
- The single construct specifies that the enclosed structured block is executed by only one thread of them.(It's up to the runtime which thread that is)

- Useful for:
    - I/O
    - Memory allocation and deallocation, etc.

### The master Construct

```cpp
#pragma omp master[clause]
... structured block ...
```

- The master construct specifies that the enclosed structured block is executed only by the master thread of team.

- Note: The master construct is no worksharing construct ans does not contain an implicit barrier at the end.
